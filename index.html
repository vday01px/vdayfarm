<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>N√¥ng Tr·∫°i H·∫°nh Ph√∫c</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{margin:0;background:#d9f7c4;font-family:Arial,sans-serif;color:#333}
.top-bar{display:flex;justify-content:space-between;padding:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.player-box{display:flex;align-items:center;background:#ffecc7;padding:10px 15px;border-radius:20px}
.avatar{width:40px;height:40px;border-radius:50%;margin-right:10px}
.wallet{display:flex;align-items:center;background:#fff8d8;padding:8px 15px;border-radius:20px;font-weight:bold}
.wallet img{width:22px;margin-right:8px}
.field{margin:20px auto;display:flex;justify-content:center}
.grid{width:330px;display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.cell{width:100px;height:100px;background:#e3ffc7;border-radius:20px;box-shadow:0 5px 0 #a9c69b;display:flex;justify-content:center;align-items:center;font-size:50px;cursor:pointer;position:relative;transition:0.3s}
.cell:hover{transform:scale(1.1)}
.cell.locked{background:#ddd;color:#999;font-size:16px}
.cell.ready{background:#ffd700;animation:glow 1.5s infinite;box-shadow:0 0 30px gold}
.cell.boosted{box-shadow:0 0 30px lime !important}
@keyframes glow{0%,100%{box-shadow:0 0 20px gold}50%{box-shadow:0 0 50px orange}}
.time-left{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:2px 8px;border-radius:8px;font-size:12px}
.bottom-menu{position:fixed;bottom:0;width:100%;background:#fff;padding:10px;display:flex;box-shadow:0 -5px 15px rgba(0,0,0,0.2);z-index:10}
.menu-btn{flex:1;margin:0 5px;padding:14px;background:#ffe2a7;border:none;border-radius:20px;font-weight:bold}
#harvestBtn{background:#f44336;color:white;display:none}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:20}
.hidden{display:none}
.popup-box{background:white;padding:25px;border-radius:25px;width:90%;max-width:400px;max-height:90%;overflow-y:auto}
.gift-input{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:12px;font-size:16px}
.close-btn,.rut-btn{width:100%;padding:14px;margin-top:10px;border:none;border-radius:15px;color:white;font-weight:bold}
.close-btn{background:#4caf50}
.rut-btn{background:#f44336}
</style>
</head>
<body>

<div class="top-bar">
    <div class="player-box">
        <img src="https://i.imgur.com/8Km9tLL.png" class="avatar">
        <div>
            <div id="playerName" style="font-weight:bold">N√¥ng d√¢n</div>
            <div id="playerLevel" style="font-size:13px;color:#666">Lv.1 ‚Ä¢ 0/120 exp</div>
        </div>
    </div>
    <div class="wallet"><img src="https://i.imgur.com/xUdV4gj.png"><span id="diamond">0</span></div>
    <div class="wallet"><img src="https://i.imgur.com/3apXK4F.png"><span id="gold">0</span></div>
</div>

<div class="field"><div id="grid" class="grid"></div></div>

<div class="bottom-menu">
    <button onclick="openTab('tasks')" class="menu-btn">Task</button>
    <button onclick="openTab('shop')" class="menu-btn">Shop</button>
    <button id="harvestBtn" onclick="harvestAll()" class="menu-btn">Thu h·∫øt!</button>
    <button onclick="openTab('withdraw')" class="menu-btn">R√∫t ti·ªÅn</button>
</div>

<div id="popup" class="popup hidden">
    <div class="popup-box">
        <div id="popupContent"></div>
        <button onclick="closePopup()" class="close-btn">ƒê√≥ng</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();
const userId = tg.initDataUnsafe?.user?.id || 'guest';
document.getElementById("playerName").textContent = tg.initDataUnsafe?.user?.first_name || "N√¥ng d√¢n";

let data = JSON.parse(localStorage.getItem('nthp_' + userId) || '{}');
if (!data.gold) data = {gold:0,diamond:0,exp:0,level:1,plots:Array(9).fill().map((_,i)=>({locked:i>0,planted_at:null})),boost:{speed:0}};

const GROW_TIME = 18900000; // 5h15p = 18900 gi√¢y
const PROFIT = 6; // 6 xu m·ªói l·∫ßn

function save(){ localStorage.setItem('nthp_'+userId, JSON.stringify(data)); }
function getTime(p){ let t=GROW_TIME; if(data.boost.speed>Date.now()) t/=10; return t; }

function render(){
    document.getElementById('gold').textContent = data.gold.toLocaleString();
    document.getElementById('diamond').textContent = data.diamond;
    document.getElementById('playerLevel').textContent = `Lv.${data.level} ‚Ä¢ ${data.exp}/${data.level*120} exp`;
    const g=document.getElementById('grid'); g.innerHTML='';
    let ready=false;
    data.plots.forEach((p,i)=>{
        const c=document.createElement('div'); c.className='cell';
        if(p.locked){
            c.innerHTML=`√î ${i+1}<br>üîí 20k xu`;
            c.onclick=()=>unlock(i);
        }else if(!p.planted_at){
            c.innerHTML='+';
            c.onclick=()=>plant(i);
        }else{
            const left = getTime(p) - (Date.now() - p.planted_at);
            if(left<=0){
                c.classList.add('ready'); c.innerHTML='‚ú®'; ready=true;
                c.onclick=()=>harvest(i);
            }else{
                c.innerHTML='üå±';
                if(data.boost.speed>Date.now()) c.classList.add('boosted');
                const m=Math.ceil(left/60000);
                c.innerHTML+=`<div class="time-left">${m}'</div>`;
            }
        }
        g.appendChild(c);
    });
    document.getElementById('harvestBtn').style.display=ready?'block':'none';
}
function unlock(i){ if(data.gold>=20000){data.gold-=20000;data.plots[i].locked=false;save();render();tg.showAlert('M·ªü √¥ th√†nh c√¥ng!');} }
function plant(i){ data.plots[i].planted_at=Date.now(); save(); render(); }
function harvest(i){
    data.gold += PROFIT;
    data.exp += 10;
    data.plots[i].planted_at=null;
    checkLevel(); save(); render(); updateUI();
    tg.HapticFeedback.impactOccurred('heavy');
}
function harvestAll(){
    let total=0;
    data.plots.forEach((p,i)=>{
        if(p.planted_at && Date.now()-p.planted_at >= getTime(p)){
            total+=PROFIT; data.plots[i].planted_at=null;
        }
    });
    if(total>0){
        data.gold+=total; data.exp+=total*2; checkLevel();
        save(); render(); updateUI();
        tg.showAlert(`Thu h·∫øt +${total} xu!`);
    }
}
function checkLevel(){
    const need=data.level*120;
    if(data.exp>=need){
        data.level++; data.exp-=need; data.diamond+=1;
        tg.showAlert(`L√™n Lv.${data.level}! +1 kim c∆∞∆°ng`);
    }
}
function updateUI(){ /* ƒë√£ c√≥ trong render */ }

function openTab(t){
    const c=document.getElementById('popupContent');
    if(t==='tasks'){
        c.innerHTML=`
            <h2>üéÅ Giftcode</h2>
            <input type="text" id="code" class="gift-input" placeholder="Nh·∫≠p m√£">
            <button onclick="gift()" class="close-btn">Nh·∫≠n</button>
            <hr>
            <h2>üí∞ R√∫t ti·ªÅn</h2>
            <select id="amt"><option value="50000">50k</option><option value="100000">100k</option></select>
            <p>Ph√≠ 5 kim c∆∞∆°ng</p>
            <button onclick="rut()" class="rut-btn close-btn">R√∫t ngay</button>
        `;
    }else if(t==='shop'){
        c.innerHTML=`
            <h2>Boost</h2>
            <button onclick="boost()" class="close-btn">TƒÉng t·ªëc 10x ‚Ä¢ 10 ph√∫t (1 kim c∆∞∆°ng)</button>
            <button onclick="vip()" class="close-btn">M·ªü √¥ VIP (100 kim c∆∞∆°ng)</button>
        `;
    }
    document.getElementById('popup').classList.remove('hidden');
}
function closePopup(){ document.getElementById('popup').classList.add('hidden'); }
function gift(){
    if(document.getElementById('code').value==='TEST123'){
        data.gold+=10000; save(); render(); tg.showAlert('+10k xu!'); closePopup();
    }else tg.showAlert('Sai code!');
}
function boost(){
    if(data.diamond>=1){
        data.diamond-=1; data.boost.speed=Date.now()+600000;
        save(); render(); tg.showAlert('TƒÉng t·ªëc 10x trong 10 ph√∫t!'); closePopup();
    }
}
function vip(){
    if(data.diamond>=100){
        data.diamond-=100;
        const i=data.plots.findIndex(p=>p.locked);
        if(i!==-1) data.plots[i].locked=false;
        save(); render(); tg.showAlert('M·ªü √¥ VIP!'); closePopup();
    }
}
function rut(){
    const amt=parseInt(document.getElementById('amt').value);
    if(data.gold>=amt && data.diamond>=5){
        data.gold-=amt; data.diamond-=5;
        save(); render(); tg.showAlert('R√∫t th√†nh c√¥ng! Th·∫ª g·ª≠i trong 5 ph√∫t'); closePopup();
    }else tg.showAlert('Kh√¥ng ƒë·ªß xu ho·∫∑c kim c∆∞∆°ng!');
}

setInterval(render,1000);
render();
</script>
</body>
</html>
