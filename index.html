<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>N√¥ng Tr·∫°i H·∫°nh Ph√∫c</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* Gi·ªØ nguy√™n style c≈©, ch·ªâ th√™m v√†i hi·ªáu ·ª©ng */
.cell.ready{animation:glow 1.5s infinite}
@keyframes glow{0%,100%{box-shadow:0 0 20px gold}50%{box-shadow:0 0 40px orange}}
.cell.boosted{box-shadow:0 0 30px #00ff00 !important;background:#90ff90 !important}
.time-left{font-size:11px !important}
</style>
</head>
<body>
<!-- Gi·ªØ nguy√™n giao di·ªán c≈© -->
<div class="top-bar"> ... </div>
<div class="field"><div id="grid" class="grid"></div></div>
<div class="bottom-menu">
    <button onclick="openTab('tasks')" class="menu-btn">Task</button>
    <button onclick="openTab('shop')" class="menu-btn">Shop</button>
    <button onclick="harvestAllReady()" class="menu-btn" id="harvestBtn" style="display:none;background:#ff5722;color:white">Thu h·∫øt!</button>
    <button onclick="openTab('withdraw')" class="menu-btn">R√∫t ti·ªÅn</button>
</div>
<div id="popup" class="popup hidden"><div class="popup-box"><div id="popupContent"></div><button onclick="closePopup()" class="close-btn">ƒê√≥ng</button></div></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();
const userId = tg.initDataUnsafe?.user?.id || 'guest';
document.getElementById("playerName").textContent = tg.initDataUnsafe?.user?.first_name || "N√¥ng d√¢n";

let data = JSON.parse(localStorage.getItem(`nthp_${userId}`) || '{}');
if (!data.gold) data = {
    gold: 0, diamond: 0, exp: 0, level: 1,
    plots: Array(9).fill().map((_,i)=>({locked:i>0, planted_at:null, type:0})),
    boosts: {speed:0}
};

const PLANTS = [
    {name:"C·∫£i b·∫Øp", time: 18900000, profit:6},    // 5h15p = 18900s
    {name:"C√† r·ªët", time: 14400000, profit:12},   // 4h
    {name:"D√¢u t√¢y", time: 10800000, profit:30}   // 3h
];

function saveData(){ localStorage.setItem(`nthp_${userId}`, JSON.stringify(data)); }
function getGrowTime(plot){ 
    let t = PLANTS[plot.type || 0].time;
    if (data.boosts.speed > Date.now()) t /= 10; // boost 10x
    return t;
}
function getProfit(plot){ return PLANTS[plot.type || 0].profit; }

function renderPlots(){
    const g = document.getElementById("grid"); g.innerHTML="";
    let hasReady = false;
    data.plots.forEach((p,i)=>{
        const c = document.createElement("div");
        c.className = "cell";
        if (p.locked){
            c.innerHTML = `√î ${i+1}<br>üîí 20k xu`;
            c.onclick = ()=>unlockPlot(i);
        } else if (!p.planted_at){
            c.innerHTML = "+";
            c.onclick = ()=>plant(i);
        } else {
            const elapsed = Date.now() - p.planted_at;
            const timeLeft = getGrowTime(p) - elapsed;
            if (timeLeft <= 0){
                c.classList.add("ready");
                c.innerHTML = "‚ú®";
                c.onclick = ()=>harvest(i);
                hasReady = true;
            } else {
                c.classList.add("planted");
                if (data.boosts.speed > Date.now()) c.classList.add("boosted");
                c.innerHTML = "üå±";
                const m = Math.ceil(timeLeft/60000);
                c.innerHTML += `<div class="time-left">${m}'</div>`;
            }
        }
        g.appendChild(c);
    });
    document.getElementById("harvestBtn").style.display = hasReady?"block":"none";
}

function unlockPlot(i){
    if (data.gold >= 20000){
        data.gold -= 20000;
        data.plots[i].locked = false;
        saveData(); renderPlots(); updateUI();
        tg.showAlert("M·ªü √¥ th√†nh c√¥ng!");
    }
}
function plant(i){
    data.plots[i].planted_at = Date.now();
    saveData(); renderPlots();
}
function harvest(i){
    data.gold += getProfit(data.plots[i]);
    data.exp += 10;
    data.plots[i].planted_at = null;
    checkLevelUp();
    saveData(); renderPlots(); updateUI();
    tg.HapticFeedback.impactOccurred("heavy");
}
function harvestAllReady(){
    let total = 0;
    data.plots.forEach((p,i)=>{
        if (p.planted_at && (Date.now() - p.planted_at) >= getGrowTime(p)){
            total += getProfit(p);
            data.plots[i].planted_at = null;
        }
    });
    if (total>0){
        data.gold += total;
        data.exp += total;
        checkLevelUp();
        saveData(); renderPlots(); updateUI();
        tg.showAlert(`Thu ho·∫°ch t·∫•t c·∫£ +${total} xu!`);
    }
}
function checkLevelUp(){
    const need = data.level * 120;
    if (data.exp >= need){
        data.level++;
        data.exp -= need;
        data.diamond += 1;
        tg.showAlert(`L√™n Lv.${data.level}! +1 kim c∆∞∆°ng`);
    }
}
function updateUI(){
    document.getElementById('gold').textContent = data.gold.toLocaleString();
    document.getElementById('diamond').textContent = data.diamond;
    document.getElementById('playerLevel').textContent = `Lv.${data.level} ‚Ä¢ ${data.exp}/${data.level*120} exp`;
}

function openTab(t){
    const c = document.getElementById("popupContent");
    if (t==='shop'){
        c.innerHTML = `
            <h2>Boost & VIP</h2>
            <button onclick="buyBoost()" class="close-btn">TƒÉng t·ªëc 10x - 10 ph√∫t (1 kim c∆∞∆°ng)</button>
            <button onclick="buyVipPlot()" class="close-btn">M·ªü √¥ VIP (100 kim c∆∞∆°ng)</button>
        `;
    } else if (t==='withdraw'){
        c.innerHTML = `
            <h2>R√∫t ti·ªÅn th·∫ª c√†o</h2>
            <select id="amount"><option value="50000">50k</option><option value="100000">100k</option></select>
            <p>Ph√≠ r√∫t: 5 kim c∆∞∆°ng</p>
            <button onclick="withdraw()" class="rut-btn close-btn">R√∫t ngay</button>
        `;
    }
    document.getElementById("popup").classList.remove("hidden");
}
function closePopup(){ document.getElementById("popup").classList.add("hidden"); }

function buyBoost(){
    if (data.diamond >= 1){
        data.diamond -= 1;
        data.boosts.speed = Date.now() + 600000; // 10 ph√∫t
        tg.showAlert("TƒÉng t·ªëc 10x trong 10 ph√∫t!");
        saveData(); renderPlots(); updateUI(); closePopup();
    }
}
function buyVipPlot(){
    if (data.diamond >= 100){
        data.diamond -= 100;
        const locked = data.plots.findIndex(p=>p.locked);
        if (locked !== -1) data.plots[locked].locked = false;
        tg.showAlert("M·ªü √¥ VIP th√†nh c√¥ng!");
        saveData(); renderPlots(); updateUI(); closePopup();
    }
}
function withdraw(){
    const amount = parseInt(document.getElementById("amount").value);
    if (data.gold >= amount && data.diamond >= 5){
        data.gold -= amount;
        data.diamond -= 5;
        tg.showAlert(`R√∫t ${amount/1000}k th√†nh c√¥ng! Th·∫ª c√†o g·ª≠i trong 5 ph√∫t`);
        saveData(); updateUI(); closePopup();
    } else tg.showAlert("Kh√¥ng ƒë·ªß xu ho·∫∑c kim c∆∞∆°ng!");
}

setInterval(renderPlots, 1000);
renderPlots(); updateUI();
</script>
</body>
</html>
