<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>N√¥ng Tr·∫°i H·∫°nh Ph√∫c</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{margin:0;background:#d9f7c4;font-family:Arial,sans-serif}
.top-bar{display:flex;justify-content:space-between;padding:12px}
.player-box{display:flex;align-items:center;background:#ffecc7;padding:8px 12px;border-radius:16px}
.avatar{width:38px;height:38px;border-radius:50%;margin-right:8px}
.wallet{display:flex;align-items:center;background:#fff8d8;padding:8px 12px;border-radius:16px;font-size:14px;margin-left:6px}
.wallet img{width:20px;margin-right:6px}
.field{margin-top:20px;display:flex;justify-content:center}
.grid{width:320px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.cell{width:100px;height:100px;background:#e3ffc7;border-radius:14px;box-shadow:0 3px 0 #a9c69b;display:flex;justify-content:center;align-items:center;font-size:40px;cursor:pointer;transition:0.2s}
.cell:hover{transform:scale(1.1)}
.cell.ready{background:#ffd700;animation:glow 1s infinite}
@keyframes glow{0%,100%{box-shadow:0 0 20px gold}50%{box-shadow:0 0 40px orange}}
.cell.pest{background:#ff5722}
.bottom-menu{position:fixed;bottom:0;width:100%;background:#fff;padding:10px;display:flex;justify-content:space-around;box-shadow:0 -2px 8px rgba(0,0,0,0.2)}
.menu-btn{background:#ffe2a7;border:none;padding:12px 20px;border-radius:14px;font-weight:bold}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000070;display:flex;justify-content:center;align-items:center}
.hidden{display:none}
.popup-box{background:white;padding:20px;border-radius:14px;width:80%;max-height:80%;overflow:auto}
.close-btn{margin-top:12px;width:100%;padding:10px;border-radius:10px;background:#ffe2a7;border:none;font-weight:bold}
.wheel{position:relative;width:300px;height:300px;border-radius:50%;background:conic-gradient(red 0deg, orange 45deg, yellow 90deg, green 135deg, blue 180deg, purple 225deg, pink 270deg, red 315deg, orange 360deg);animation:spin 3s cubic-bezier(.25,.46,.45,.94) paused;margin:20px auto;transition:0.5s}
.wheel-pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-top:30px solid lime}
.wheel.spinning{animation-play-state:running}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.shop-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.shop-item:hover{background:#f0f0f0}
.shop-item.locked{opacity:0.5;cursor:not-allowed}
</style>
</head>
<body>

<div class="top-bar">
    <div class="player-box">
        <img src="https://i.imgur.com/8Km9tLL.png" class="avatar">
        <div><div id="playerName">ƒêang t·∫£i...</div><div id="playerLevel">Lv.1</div></div>
    </div>
    <div class="wallet"><img src="https://i.imgur.com/xUdV4gj.png"><span id="diamond">0</span></div>
    <div class="wallet"><img src="https://i.imgur.com/3apXK4F.png"><span id="gold">0</span></div>
</div>

<div class="field"><div id="grid" class="grid"></div></div>

<div class="bottom-menu">
    <button onclick="openTab('tasks')" class="menu-btn">Nhi·ªám v·ª•</button>
    <button onclick="openTab('shop')" class="menu-btn">C·ª≠a h√†ng</button>
    <button onclick="openTab('wheel')" class="menu-btn">Quay!</button>
    <button onclick="openTab('bag')" class="menu-btn">T√∫i</button>
</div>

<div id="popup" class="popup hidden">
    <div class="popup-box">
        <div id="popupContent"></div>
        <button onclick="closePopup()" class="close-btn">ƒê√≥ng</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();
const userName = tg.initDataUnsafe?.user?.first_name || "Ng∆∞·ªùi ch∆°i";
document.getElementById("playerName").innerText = userName;

let data = JSON.parse(localStorage.getItem("farmData_" + tg.initDataUnsafe.user?.id || "guest") || "{}");
if (!data.cells) data = {gold:0, diamond:0, exp:0, level:1, cells:Array(9).fill(0), unlockedPlants:[0]};

const plants = [
    {id:0, name:'C·∫£i b·∫Øp', price:50, expReq:0, emoji:'ü•¨'},
    {id:1, name:'C√† r·ªët', price:100, expReq:500, emoji:'ü•ï'},
    {id:2, name:'D√¢u t√¢y', price:300, expReq:2000, emoji:'üçì'},
    {id:3, name:'Rau bina VIP', price:1000, expReq:5000, emoji:'ü•¨‚ú®'}
];

function save(){ localStorage.setItem("farmData_" + tg.initDataUnsafe.user?.id || "guest", JSON.stringify(data)); }
function render(){
    document.getElementById("gold").innerText = data.gold.toLocaleString();
    document.getElementById("diamond").innerText = data.diamond;
    document.getElementById("playerLevel").innerText = `Lv.${data.level} ‚Ä¢ ${data.exp.toLocaleString()}/${data.level*120} exp`;
    const g = document.getElementById("grid"); g.innerHTML="";
    data.cells.forEach((lv,i)=>{
        const c = document.createElement("div");
        c.className = "cell";
        c.innerHTML = lv===0 ? "+" : plants[data.selectedPlant || 0].emoji + lv;
        if (isReady(i)) c.classList.add('ready');
        c.onclick = ()=>click(i);
        g.appendChild(c);
    });
}
function isReady(i){
    return data.cells[i] > 0 && Math.random() < 0.1; // Gi·∫£ l·∫≠p ready
}
function click(i){
    if (data.cells[i] === 0) {
        data.cells[i] = 1;
    } else if (isReady(i)) {
        data.gold += data.cells[i] * 15;
        data.exp += data.cells[i] * 10;
        data.cells[i]++;
        checkLevelUp();
    }
    save(); render();
}
function checkLevelUp(){
    const need = data.level * 120;
    if (data.exp >= need){
        data.level++;
        data.exp -= need;
        data.diamond += 1; // Bonus kim c∆∞∆°ng
        tg.showAlert("L√™n c·∫•p " + data.level + "! +1 kim c∆∞∆°ng");
    }
    save(); render();
}

function openTab(tab){
    const content = document.getElementById("popupContent");
    if (tab === 'shop'){
        content.innerHTML = '<h2>C·ª≠a h√†ng c√¢y tr·ªìng</h2>' + plants.map((p,i) => {
            const unlocked = data.exp >= p.expReq && data.unlockedPlants.includes(i);
            return `<div class="shop-item ${unlocked ? '' : 'locked'}" onclick="${unlocked ? `buyPlant(${i})` : ''}">
                ${p.emoji} ${p.name} - ${p.price.toLocaleString()} xu<br>
                ${!unlocked ? `Unlock: ${p.expReq.toLocaleString()} exp` : 'ƒê√£ unlock'}
            </div>`;
        }).join('');
    } else if (tab === 'wheel'){
        content.innerHTML = '<h2>V√≤ng quay may m·∫Øn</h2><p>1 l∆∞·ª£t = 1 kim c∆∞∆°ng</p><div class="wheel" id="wheel"><div class="wheel-pointer"></div></div><button onclick="spinWheel()" class="close-btn">QUAY NGAY (1 kim c∆∞∆°ng)</button>';
        document.getElementById("popup").classList.remove("hidden");
    } else {
        content.innerHTML = '<h2>' + tab + '</h2><p>N·ªôi dung s·∫Øp c√≥...</p>';
    }
    document.getElementById("popup").classList.remove("hidden");
}
function closePopup(){ document.getElementById("popup").classList.add("hidden"); }

function buyPlant(id){
    const p = plants[id];
    if (data.gold >= p.price && data.exp >= p.expReq && !data.unlockedPlants.includes(id)){
        data.gold -= p.price;
        data.unlockedPlants.push(id);
        data.selectedPlant = id;
        tg.showAlert("Mua " + p.name + " th√†nh c√¥ng! ƒê√£ ch·ªçn l√†m c√¢y tr·ªìng m·∫∑c ƒë·ªãnh.");
        closePopup(); save(); render();
    }
}

function spinWheel(){
    if (data.diamond < 1) return tg.showAlert("H·∫øt kim c∆∞∆°ng!");
    data.diamond--;
    const wheel = document.getElementById("wheel");
    wheel.classList.add("spinning");
    const expReward = [10, 50, 100, 200, 500, 1000][Math.floor(Math.random()*6)];
    setTimeout(() => {
        wheel.classList.remove("spinning");
        data.exp += expReward;
        tg.showAlert("Quay tr√∫ng " + expReward + " exp!");
        checkLevelUp();
        save(); render();
    }, 3000);
}

render();
</script>
</body>
</html>
